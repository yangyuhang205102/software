<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>智慧校园公共设施管理系统</title>
  <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/antd/5.12.8/antd.min.css">
  <style>
    /* 全局样式 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
    }
    .auth-page {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: #f5f5f5;
    }
    .auth-card {
      width: 400px;
      padding: 32px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    }
    .auth-title {
      text-align: center;
      font-size: 24px;
      font-weight: 500;
      margin-bottom: 24px;
      color: #001529;
    }
    .auth-form .form-item {
      margin-bottom: 16px;
    }
    .auth-form label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: #333;
    }
    .auth-form input, .auth-form select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      font-size: 14px;
    }
    .auth-form input:focus, .auth-form select:focus {
      outline: none;
      border-color: #1890ff;
      box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
    }
    .radio-group {
      display: flex;
      gap: 20px;
      padding: 8px 0;
      flex-wrap: wrap;
    }
    .radio-item {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    .radio-item input {
      width: auto;
      margin: 0;
    }
    .auth-btn {
      width: 100%;
      padding: 10px;
      background: #1890ff;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 16px;
    }
    .auth-btn:hover {
      background: #40a9ff;
    }
    .auth-error {
      color: #ff4d4f;
      font-size: 12px;
      margin-bottom: 16px;
      text-align: center;
      display: none;
    }
    .auth-tip {
      text-align: center;
      font-size: 14px;
      color: #666;
    }
    .auth-switch {
      color: #1890ff;
      cursor: pointer;
      text-decoration: none;
    }
    .auth-switch:hover {
      color: #40a9ff;
      text-decoration: underline;
    }
    .nav-header {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 999;
      width: 100%;
      height: 64px;
      background: #001529;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      display: none;
    }
    .logo {
      color: #fff;
      font-size: 18px;
      font-weight: bold;
      white-space: nowrap;
    }
    .nav-menu {
      display: flex;
      margin: 0 20px;
      flex: 1;
      max-width: 600px;
    }
    .menu-item {
      color: #fff;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 16px;
      height: 64px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .menu-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    .menu-item.active {
      background: #1890ff;
    }
    .menu-item svg {
      width: 16px;
      height: 16px;
      fill: #fff;
    }
    .admin-menu {
      display: none;
    }
    /* 退出登录按钮 - 修复排版异常 + 自适应宽度 */
    .logout-btn {
      background: #1890ff;
      color: #fff;
      border: none;
      border-radius: 4px;
      width: auto; /* 自适应宽度 */
      height: 36px;
      line-height: 36px;
      padding: 0 16px; /* 左右内边距保证空间 */
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px; /* 图标与文字间距 */
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
      white-space: nowrap; /* 禁止文字换行 */
    }
    .logout-btn:hover {
      background: #40a9ff;
    }
    .logout-btn svg {
      width: 16px;
      height: 16px;
      fill: #fff;
    }
    .main-content {
      margin-top: 84px;
      padding: 24px;
      background: #fff;
      margin-left: 24px;
      margin-right: 24px;
      border-radius: 8px;
      min-height: 500px;
      display: none;
    }
    .page-title {
      font-size: 20px;
      font-weight: 500;
      margin-bottom: 20px;
    }
    .add-user-btn {
      padding: 8px 16px;
      background: #52c41a;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      margin-bottom: 16px;
    }
    .add-user-btn:hover {
      background: #73d13d;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin-bottom: 24px;
    }
    .data-table th {
      background: #fafafa;
      font-weight: 500;
      color: #333;
    }
    .data-table th, .data-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
    }
    .data-table tr:hover {
      background: #f9f9f9;
    }
    .status-tag {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    .status-normal {
      background: #f0f9ff;
      color: #1890ff;
    }
    .status-pending {
      background: #fff7e6;
      color: #faad14;
    }
    .operate-btn {
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      margin-right: 8px;
    }
    .status-btn {
      background: #e6f7ff;
      color: #1890ff;
    }
    .delete-btn {
      background: #fff2f0;
      color: #ff4d4f;
    }
    .submit-btn {
      background: #1890ff;
      color: #fff;
      padding: 8px 16px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 8px;
    }
    .submit-btn:hover {
      background: #40a9ff;
    }
    .repair-form {
      background: #f9f9f9;
      padding: 24px;
      border-radius: 8px;
      margin-bottom: 24px;
      max-width: 600px;
    }
    .repair-form .form-item {
      margin-bottom: 16px;
    }
    .repair-form label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
    }
    .repair-form select, .repair-form textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      font-size: 14px;
    }
    .repair-form textarea {
      min-height: 100px;
      resize: vertical;
    }
    .disabled-select {
      background-color: #f5f5f5;
      color: #999;
    }
    .modal-mask {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      display: none;
    }
    .modal-card {
      width: 400px;
      padding: 24px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }
    .modal-title {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 16px;
      color: #333;
    }
    .modal-form .form-item {
      margin-bottom: 16px;
    }
    .modal-form label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .modal-btn-group {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }
    .modal-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }
    .confirm-btn {
      background: #1890ff;
      color: #fff;
    }
    .cancel-btn {
      background: #f5f5f5;
      color: #666;
    }
  </style>
</head>
<body>
  <!-- 登录页面 -->
  <div class="auth-page" id="login-page">
    <div class="auth-card">
      <div class="auth-title">智慧校园公共设施管理系统</div>
      <div class="auth-error" id="login-error">用户名或密码错误</div>
      <form class="auth-form" id="login-form">
        <div class="form-item">
          <label for="login-username">用户名</label>
          <input type="text" id="login-username" placeholder="请输入用户名" required>
        </div>
        <div class="form-item">
          <label for="login-password">密码</label>
          <input type="password" id="login-password" placeholder="请输入密码" required>
        </div>
        <div class="form-item">
          <label>登录身份</label>
          <div class="radio-group">
            <div class="radio-item">
              <input type="radio" name="login-type" id="login-admin" value="admin" required>
              <label for="login-admin">管理员</label>
            </div>
            <div class="radio-item">
              <input type="radio" name="login-type" id="login-teacher" value="teacher">
              <label for="login-teacher">老师</label>
            </div>
            <div class="radio-item">
              <input type="radio" name="login-type" id="login-student" value="student">
              <label for="login-student">学生</label>
            </div>
          </div>
        </div>
        <button type="submit" class="auth-btn">登录</button>
        <div class="auth-tip">
          还没有账号？<span class="auth-switch" id="to-register">立即注册</span>
        </div>
      </form>
    </div>
  </div>

  <!-- 注册页面 -->
  <div class="auth-page" id="register-page" style="display: none;">
    <div class="auth-card">
      <div class="auth-title">用户注册</div>
      <div class="auth-error" id="register-error">注册失败，请检查信息</div>
      <form class="auth-form" id="register-form">
        <div class="form-item">
          <label for="reg-username">用户名</label>
          <input type="text" id="reg-username" placeholder="请输入用户名（3-16位）" required>
        </div>
        <div class="form-item">
          <label for="reg-password">密码</label>
          <input type="password" id="reg-password" placeholder="请输入密码（6-16位）" required>
        </div>
        <div class="form-item">
          <label for="reg-repassword">确认密码</label>
          <input type="password" id="reg-repassword" placeholder="请再次输入密码" required>
        </div>
        <div class="form-item">
          <label for="reg-phone">联系电话</label>
          <input type="tel" id="reg-phone" placeholder="请输入联系电话" required>
        </div>
        <div class="form-item">
          <label>用户身份</label>
          <div class="radio-group">
            <div class="radio-item">
              <input type="radio" name="reg-type" id="reg-teacher" value="teacher" required>
              <label for="reg-teacher">老师</label>
            </div>
            <div class="radio-item">
              <input type="radio" name="reg-type" id="reg-student" value="student">
              <label for="reg-student">学生</label>
            </div>
          </div>
        </div>
        <div class="form-item">
          <label for="reg-gender">性别</label>
          <select id="reg-gender" required>
            <option value="">请选择性别</option>
            <option value="男">男</option>
            <option value="女">女</option>
            <option value="其他">其他</option>
          </select>
        </div>
        <button type="submit" class="auth-btn">注册</button>
        <div class="auth-tip">
          已有账号？<span class="auth-switch" id="to-login">立即登录</span>
        </div>
      </form>
    </div>
  </div>

  <!-- 系统主页面 -->
  <header class="nav-header" id="nav-header">
    <div class="logo">智慧校园公共设施管理系统</div>
    <div class="nav-menu">
      <a id="menu-facility" class="menu-item active" href="javascript:;">
        <svg viewBox="64 64 896 896" focusable="false">
          <path d="M946.5 505L538.9 161.2c-14.2-12.2-35-12.2-49.2 0L77.5 505a63.9 63.9 0 0 0-18.8 46c.4 35.2 29.7 63.6 65 63.6h42.5V908c0 17.7 14.2 32 31.9 32H448V714h112v196h265.4c17.7 0 32-14.3 32-32V614.7h41.3c35.2 0 64.7-28.4 65-63.6.1-7.8-1.3-15.5-4.1-22.9zM512 512c79.5 0 144-64.5 144-144s-64.5-144-144-144-144 64.5-144 144 64.5 144 144 144zm0-320c105.9 0 192 86.1 192 192s-86.1 192-192 192-192-86.1-192-192 86.1-192 192-192z"/>
        </svg>
        设施列表
      </a>
      <a id="menu-add" class="menu-item" href="javascript:;">
        <svg viewBox="64 64 896 896" focusable="false">
          <path d="M909.9 854.5L649.4 594c-12.5-12.5-32.8-12.5-45.3 0L420.7 725.7l-73.2-73.2c-12.5-12.5-32.8-12.5-45.3 0L114.1 759.7c-12.5 12.5-12.5 32.8 0 45.3l278.6 278.6c12.5 12.5 32.8 12.5 45.3 0l424.4-424.4c12.5-12.5 12.5-32.8 0-45.3zM266.3 883.6L153 770.3l145.5-145.5 42.4 42.4-78.1 78.1-42.4-42.4L195.4 650l145.5-145.5 213.2 213.2-294.4 294.4-42.4-42.4zm532.3-379.2L671.7 424l-136.2 136.2 42.4 42.4 93.8-93.8 42.4 42.4 196.4-196.4-136.2-136.2-196.4 196.4-42.4-42.4-93.8 93.8-42.4-42.4L352.3 284.7l136.2-136.2 424.4 424.4-136.2 136.2z"/>
        </svg>
        添加设施
      </a>
      <a id="menu-repair" class="menu-item" href="javascript:;">
        <svg viewBox="64 64 896 896" focusable="false">
          <path d="M878 256H728v-64c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v64H384v-64c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v64H146c-17.7 0-32 14.3-32 32v664c0 17.7 14.3 32 32 32h732c17.7 0 32-14.3 32-32V288c0-17.7-14.3-32-32-32zM664 888H360c-4.4 0-8-3.6-8-8v-56c0-4.4 3.6-8 8-8h304c4.4 0 8 3.6 8 8v56c0 4.4-3.6 8-8 8zm0-168H360c-4.4 0-8-3.6-8-8v-56c0-4.4 3.6-8 8-8h304c4.4 0 8 3.6 8 8v56c0 4.4-3.6 8-8 8zm0-168H360c-4.4 0-8-3.6-8-8v-56c0-4.4 3.6-8 8-8h304c4.4 0 8 3.6 8 8v56c0 4.4-3.6 8-8 8z"/>
        </svg>
        报修管理
      </a>
      <a id="menu-user" class="menu-item admin-menu" href="javascript:;">
        <svg viewBox="64 64 896 896" focusable="false">
          <path d="M878 256H728v-64c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v64H384v-64c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v64H146c-17.7 0-32 14.3-32 32v664c0 17.7 14.3 32 32 32h732c17.7 0 32-14.3 32-32V288c0-17.7-14.3-32-32-32zM664 888H360c-4.4 0-8-3.6-8-8v-56c0-4.4 3.6-8 8-8h304c4.4 0 8 3.6 8 8v56c0 4.4-3.6 8-8 8zm0-168H360c-4.4 0-8-3.6-8-8v-56c0-4.4 3.6-8 8-8h304c4.4 0 8 3.6 8 8v56c0 4.4-3.6 8-8 8zm0-168H360c-4.4 0-8-3.6-8-8v-56c0-4.4 3.6-8 8-8h304c4.4 0 8 3.6 8 8v56c0 4.4-3.6 8-8 8z"/>
        </svg>
        用户管理
      </a>
    </div>
    <button id="logout-btn" class="logout-btn">
      <svg viewBox="64 64 896 896" focusable="false">
        <path d="M858.5 763.6a374 374 0 0 0-80.6-119.5 375.63 375.63 0 0 0-119.5-80.6c-4.8-.8-9.6-1.2-14.3-1.2H512c-4.7 0-9.5.4-14.3 1.2a375.63 375.63 0 0 0-119.5 80.6 374 374 0 0 0-80.6 119.5c-.8 4.8-1.2 9.6-1.2 14.3v42.8c0 27.6 22.4 50 50 50h420c27.6 0 50-22.4 50-50v-42.8c.1-4.7-.3-9.5-1.1-14.3zM512 512c79.5 0 144-64.5 144-144s-64.5-144-144-144-144 64.5-144 144 64.5 144 144 144zm0-320c105.9 0 192 86.1 192 192s-86.1 192-192 192-192-86.1-192-192 86.1-192 192-192z"/>
      </svg>
      退出登录
    </button>
  </header>

  <!-- 主内容区 -->
  <main class="main-content" id="main-content">
    <div class="page-title" id="page-title">设施列表</div>
    <div id="page-content">
      <table class="data-table">
        <thead>
          <tr>
            <th>序号</th>
            <th>设备编号</th>
            <th>设备类型</th>
            <th>状态</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>1</td>
            <td>88010001</td>
            <td>饮水设备</td>
            <td><span class="status-tag status-normal">正常</span></td>
          </tr>
          <tr>
            <td>2</td>
            <td>88010002</td>
            <td>制冷设备</td>
            <td><span class="status-tag status-pending">待维修</span></td>
          </tr>
          <tr>
            <td>3</td>
            <td>88010003</td>
            <td>照明设备</td>
            <td><span class="status-tag status-normal">正常</span></td>
          </tr>
          <tr>
            <td>4</td>
            <td>88010004</td>
            <td>教学设备</td>
            <td><span class="status-tag status-pending">待维修</span></td>
          </tr>
          <tr>
            <td>5</td>
            <td>88010005</td>
            <td>便民设备</td>
            <td><span class="status-tag status-normal">正常</span></td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>

  <!-- 添加/编辑用户弹窗 -->
  <div class="modal-mask" id="user-modal">
    <div class="modal-card">
      <div class="modal-title" id="modal-title">添加用户</div>
      <form class="modal-form" id="user-form">
        <input type="hidden" id="user-id" value="">
        <div class="form-item">
          <label for="modal-username">用户名</label>
          <input type="text" id="modal-username" placeholder="请输入用户名" required>
        </div>
        <div class="form-item">
          <label for="modal-password">密码</label>
          <input type="password" id="modal-password" placeholder="请输入密码（编辑时留空则不修改）">
        </div>
        <div class="form-item">
          <label for="modal-phone">联系电话</label>
          <input type="tel" id="modal-phone" placeholder="请输入联系电话" required>
        </div>
        <div class="form-item">
          <label>用户身份</label>
          <div class="radio-group">
            <div class="radio-item">
              <input type="radio" name="modal-type" id="modal-teacher" value="teacher" required>
              <label for="modal-teacher">老师</label>
            </div>
            <div class="radio-item">
              <input type="radio" name="modal-type" id="modal-student" value="student">
              <label for="modal-student">学生</label>
            </div>
          </div>
        </div>
        <div class="form-item">
          <label for="modal-gender">性别</label>
          <select id="modal-gender" required>
            <option value="">请选择性别</option>
            <option value="男">男</option>
            <option value="女">女</option>
            <option value="其他">其他</option>
          </select>
        </div>
        <div class="modal-btn-group">
          <button type="button" class="modal-btn cancel-btn" id="cancel-btn">取消</button>
          <button type="submit" class="modal-btn confirm-btn">保存</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // 初始化测试数据
    if (!localStorage.getItem('registered_users')) {
      localStorage.setItem('registered_users', JSON.stringify([
        { id: 1, username: 'admin', password: '123456', phone: '13800138000', userType: 'admin', gender: '男' },
        { id: 2, username: 'student01', password: '123456', phone: '13800138001', userType: 'student', gender: '男' },
        { id: 3, username: 'teacher01', password: '123456', phone: '13800138002', userType: 'teacher', gender: '女' }
      ]));
    }
    if (!localStorage.getItem('facility_list')) {
      localStorage.setItem('facility_list', JSON.stringify([
        { id: 1, code: '88010001', type: '饮水设备', status: 1 },
        { id: 2, code: '88010002', type: '制冷设备', status: 2 },
        { id: 3, code: '88010003', type: '照明设备', status: 1 },
        { id: 4, code: '88010004', type: '教学设备', status: 2 },
        { id: 5, code: '88010005', type: '便民设备', status: 1 }
      ]));
    }
    if (!localStorage.getItem('repair_records')) {
      localStorage.setItem('repair_records', JSON.stringify([]));
    }

    // 工具函数
    const getStatusText = (type, status) => {
      if (type === 'facility') {
        return status === 1 ? '正常' : '待维修';
      } else if (type === 'repair') {
        const map = { 1: '待处理', 2: '维修中', 3: '已完成', 4: '已驳回' };
        return map[status] || '待处理';
      }
    };

    const getStatusClass = (type, status) => {
      if (type === 'facility') {
        return status === 1 ? 'status-normal' : 'status-pending';
      } else if (type === 'repair') {
        const map = { 1: 'status-pending', 2: 'status-normal', 3: 'status-normal', 4: 'status-pending' };
        return map[status] || 'status-pending';
      }
    };

    // 核心：正确解析Token中的用户名
    const getCurrentUser = () => {
      const token = localStorage.getItem('token');
      const loginType = localStorage.getItem('login_type');
      
      if (!token || !loginType) {
        console.log('Token或登录类型不存在');
        return null;
      }
      
      const tokenParts = token.split('-');
      if (tokenParts.length < 3) {
        console.log('Token格式错误：', token);
        return null;
      }
      const username = tokenParts[2]; // 用户名在索引2
      
      const users = JSON.parse(localStorage.getItem('registered_users') || '[]');
      const currentUser = users.find(u => u.username === username && u.userType === loginType);
      
      if (!currentUser) {
        console.log('未找到匹配的用户：', { username, loginType });
        return null;
      }
      
      return currentUser;
    };

    const getAllFacilityTypes = () => {
      const facilities = JSON.parse(localStorage.getItem('facility_list') || '[]');
      return [...new Set(facilities.map(f => f.type))];
    };

    const getCodesByType = (type) => {
      const facilities = JSON.parse(localStorage.getItem('facility_list') || '[]');
      return facilities.filter(f => f.type === type).map(f => ({ id: f.id, code: f.code }));
    };

    // 页面配置
    const pageConfig = {
      facility: {
        title: '设施列表',
        content: function() {
          const facilities = JSON.parse(localStorage.getItem('facility_list') || '[]');
          const currentUser = getCurrentUser();
          const userType = currentUser?.userType || '';
          
          let html = `<table class="data-table">
            <thead>
              <tr>
                <th>序号</th>
                <th>设备编号</th>
                <th>设备类型</th>
                <th>状态</th>`;
          
          if (userType === 'admin') {
            html += '<th>操作</th>';
          }
          
          html += `</tr></thead><tbody>`;
          
          facilities.forEach((item, index) => {
            html += `<tr>
              <td>${index + 1}</td>
              <td>${item.code}</td>
              <td>${item.type}</td>
              <td><span class="status-tag ${getStatusClass('facility', item.status)}">${getStatusText('facility', item.status)}</span></td>`;
            
            if (userType === 'admin') {
              html += `<td>
                <button class="operate-btn status-btn" data-id="${item.id}" data-status="${item.status}">
                  ${item.status === 1 ? '设为待维修' : '设为正常'}
                </button>
                <button class="operate-btn delete-btn" data-id="${item.id}">删除</button>
              </td>`;
            }
            
            html += `</tr>`;
          });
          
          html += `</tbody></table>`;
          return html;
        }
      },
      add: {
        title: '添加设施',
        content: `
          <form class="repair-form" id="add-facility-form">
            <div class="form-item">
              <label for="facility-code">设备编号（8位数字）</label>
              <input type="text" id="facility-code" placeholder="请输入8位数字设备编号" required pattern="\\d{8}">
            </div>
            <div class="form-item">
              <label for="facility-type">设备类型</label>
              <select id="facility-type" required>
                <option value="">请选择设备类型</option>
                <option value="饮水设备">饮水设备</option>
                <option value="制冷设备">制冷设备</option>
                <option value="照明设备">照明设备</option>
                <option value="教学设备">教学设备</option>
                <option value="便民设备">便民设备</option>
              </select>
            </div>
            <button type="submit" class="submit-btn">提交添加</button>
          </form>
        `
      },
      repair: {
        title: '报修管理',
        content: function() {
          const facilities = JSON.parse(localStorage.getItem('facility_list') || '[]');
          const repairRecords = JSON.parse(localStorage.getItem('repair_records') || '[]');
          const currentUser = getCurrentUser();
          const userId = currentUser?.id || 0;
          const facilityTypes = getAllFacilityTypes();
          
          let html = `<div class="repair-form">
            <h3 style="margin-bottom: 16px;">报修申请</h3>
            <form id="repair-apply-form">
              <div class="form-item">
                <label for="repair-type">设备类型</label>
                <select id="repair-type" required>
                  <option value="">请选择设备类型</option>
                  ${facilityTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                </select>
              </div>
              <div class="form-item">
                <label for="repair-code">设备编号</label>
                <select id="repair-code" class="disabled-select" disabled required>
                  <option value="">请先选择设备类型</option>
                </select>
              </div>
              <div class="form-item">
                <label for="repair-reason">报修原因</label>
                <textarea id="repair-reason" placeholder="请详细描述设备故障情况..." required></textarea>
              </div>
              <button type="submit" class="submit-btn">提交报修</button>
            </form>
          </div>`;
          
          html += `<h3 style="margin-bottom: 16px;">我的报修记录</h3>`;
          html += `<table class="data-table">
            <thead>
              <tr>
                <th>工单编号</th>
                <th>设备编号</th>
                <th>设备类型</th>
                <th>报修时间</th>
                <th>报修原因</th>
                <th>状态</th>
              </tr></thead><tbody>`;
          
          const filteredRecords = repairRecords.filter(r => r.repairUserId === userId);
          
          if (filteredRecords.length === 0) {
            html += `<tr><td colspan="6" style="text-align:center;">暂无报修记录</td></tr>`;
          } else {
            filteredRecords.forEach(record => {
              const facility = facilities.find(f => f.id === record.facilityId) || { code: '未知', type: '未知' };
              html += `<tr data-id="${record.id}">
                <td>${record.orderNo}</td>
                <td>${facility.code}</td>
                <td>${facility.type}</td>
                <td>${record.repairTime}</td>
                <td>${record.reason}</td>
                <td><span class="status-tag ${getStatusClass('repair', record.status)}">${getStatusText('repair', record.status)}</span></td>
              </tr>`;
            });
          }
          
          html += `</tbody></table>`;
          return html;
        }
      },
      user: {
        title: '用户管理',
        content: function() {
          const users = JSON.parse(localStorage.getItem('registered_users') || '[]');
          let html = `<button class="add-user-btn" id="add-user-btn">添加用户</button>`;
          html += `
            <table class="data-table">
              <thead>
                <tr>
                  <th>用户ID</th>
                  <th>用户名</th>
                  <th>联系电话</th>
                  <th>身份</th>
                  <th>性别</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
          `;
          users.forEach(user => {
            if (user.userType !== 'admin') {
              html += `
                <tr data-id="${user.id}">
                  <td>${user.id}</td>
                  <td>${user.username}</td>
                  <td>${user.phone}</td>
                  <td>${user.userType === 'teacher' ? '老师' : '学生'}</td>
                  <td>${user.gender}</td>
                  <td>
                    <button class="operate-btn status-btn edit-user-btn">编辑</button>
                    <button class="operate-btn delete-btn delete-user-btn">删除</button>
                  </td>
                </tr>
              `;
            }
          });
          html += `
              </tbody>
            </table>
          `;
          return html;
        }
      }
    };

    // DOM元素获取
    const loginPage = document.getElementById('login-page');
    const registerPage = document.getElementById('register-page');
    const navHeader = document.getElementById('nav-header');
    const mainContent = document.getElementById('main-content');
    const userModal = document.getElementById('user-modal');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const toRegister = document.getElementById('to-register');
    const toLogin = document.getElementById('to-login');
    const menuItems = document.querySelectorAll('.menu-item');
    const logoutBtn = document.getElementById('logout-btn');
    const pageTitle = document.getElementById('page-title');
    const pageContent = document.getElementById('page-content');
    const cancelBtn = document.getElementById('cancel-btn');

    // 登录/注册切换
    toRegister.addEventListener('click', () => {
      loginPage.style.display = 'none';
      registerPage.style.display = 'flex';
      document.getElementById('register-error').style.display = 'none';
      document.getElementById('reg-teacher').checked = true;
      document.getElementById('reg-gender').value = '男';
    });

    toLogin.addEventListener('click', () => {
      registerPage.style.display = 'none';
      loginPage.style.display = 'flex';
      document.getElementById('login-error').style.display = 'none';
      document.getElementById('login-admin').checked = true;
    });

    // 登录提交
    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value.trim();
      const loginType = Array.from(document.querySelectorAll('input[name="login-type"]')).find(r => r.checked)?.value;
      
      const users = JSON.parse(localStorage.getItem('registered_users') || '[]');
      const user = users.find(u => u.username === username && u.password === password && u.userType === loginType);
      
      if (user) {
        localStorage.setItem('token', `fake-token-${username}-${Date.now()}`);
        localStorage.setItem('login_type', loginType);
        checkLoginStatus();
        alert(`登录成功！欢迎${loginType === 'admin' ? '管理员' : loginType === 'teacher' ? '老师' : '学生'} ${username}`);
      } else {
        document.getElementById('login-error').textContent = '用户名/密码/身份不匹配';
        document.getElementById('login-error').style.display = 'block';
      }
    });

    // 注册提交
    registerForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const username = document.getElementById('reg-username').value.trim();
      const password = document.getElementById('reg-password').value.trim();
      const repassword = document.getElementById('reg-repassword').value.trim();
      const phone = document.getElementById('reg-phone').value.trim();
      const regType = Array.from(document.querySelectorAll('input[name="reg-type"]')).find(r => r.checked)?.value;
      const gender = document.getElementById('reg-gender').value;
      
      const users = JSON.parse(localStorage.getItem('registered_users') || '[]');
      const errorEl = document.getElementById('register-error');
      
      if (username.length < 3 || username.length > 16) {
        errorEl.textContent = '用户名长度需在3-16位之间';
        errorEl.style.display = 'block';
        return;
      }
      if (password.length < 6 || password.length > 16) {
        errorEl.textContent = '密码长度需在6-16位之间';
        errorEl.style.display = 'block';
        return;
      }
      if (password !== repassword) {
        errorEl.textContent = '两次输入的密码不一致';
        errorEl.style.display = 'block';
        return;
      }
      if (!/^1[3-9]\d{9}$/.test(phone)) {
        errorEl.textContent = '请输入有效的手机号码';
        errorEl.style.display = 'block';
        return;
      }
      if (!gender) {
        errorEl.textContent = '请选择性别';
        errorEl.style.display = 'block';
        return;
      }
      if (users.some(u => u.username === username)) {
        errorEl.textContent = '用户名已存在，请更换';
        errorEl.style.display = 'block';
        return;
      }
      
      const newUserId = users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 2;
      users.push({
        id: newUserId,
        username,
        password,
        phone,
        userType: regType,
        gender
      });
      localStorage.setItem('registered_users', JSON.stringify(users));
      alert(`注册成功！您的身份是：${regType === 'teacher' ? '老师' : '学生'}`);
      toLogin.click();
      document.getElementById('login-username').value = username;
    });

    // 退出登录
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('token');
      localStorage.removeItem('login_type');
      checkLoginStatus();
      alert('退出登录成功！');
    });

    // 菜单点击
    menuItems.forEach(item => {
      item.addEventListener('click', () => {
        const pageKey = item.id.split('-')[1];
        const currentUser = getCurrentUser();
        const userType = currentUser?.userType || '';
        
        if (userType === 'admin' && pageKey === 'repair') {
          alert('管理员无报修管理权限！');
          return;
        }
        
        renderPage(pageKey);
      });
    });

    // 渲染页面
    function renderPage(pageKey) {
      const currentUser = getCurrentUser();
      const userType = currentUser?.userType || '';
      
      if (userType === 'admin' && pageKey === 'repair') {
        renderPage('facility');
        return;
      }
      
      menuItems.forEach(item => item.classList.remove('active'));
      document.getElementById(`menu-${pageKey}`).classList.add('active');
      pageTitle.textContent = pageConfig[pageKey].title;
      pageContent.innerHTML = typeof pageConfig[pageKey].content === 'function' 
        ? pageConfig[pageKey].content() 
        : pageConfig[pageKey].content;
      
      if (pageKey === 'repair') {
        bindRepairEvents();
      } else if (pageKey === 'add') {
        bindAddFacilityEvents();
      } else if (pageKey === 'user') {
        bindUserManageEvents();
      } else if (pageKey === 'facility') {
        bindFacilityEvents();
      }
    }

    // 绑定设施列表事件
    function bindFacilityEvents() {
      document.querySelectorAll('.status-btn[data-id]').forEach(btn => {
        btn.addEventListener('click', () => {
          const facilityId = parseInt(btn.dataset.id);
          const currentStatus = parseInt(btn.dataset.status);
          const newStatus = currentStatus === 1 ? 2 : 1;
          
          if (confirm(`确定要将该设备状态改为【${getStatusText('facility', newStatus)}】吗？`)) {
            const facilities = JSON.parse(localStorage.getItem('facility_list') || '[]');
            const index = facilities.findIndex(f => f.id === facilityId);
            if (index !== -1) {
              facilities[index].status = newStatus;
              localStorage.setItem('facility_list', JSON.stringify(facilities));
              renderPage('facility');
              alert('设备状态修改成功！');
            }
          }
        });
      });
      
      document.querySelectorAll('.delete-btn[data-id]').forEach(btn => {
        btn.addEventListener('click', () => {
          const facilityId = parseInt(btn.dataset.id);
          if (confirm('确定要删除该设备吗？删除后相关报修记录也会失效！')) {
            let facilities = JSON.parse(localStorage.getItem('facility_list') || '[]');
            facilities = facilities.filter(f => f.id !== facilityId);
            localStorage.setItem('facility_list', JSON.stringify(facilities));
            renderPage('facility');
            alert('设备删除成功！');
          }
        });
      });
    }

    // 绑定报修事件
    function bindRepairEvents() {
      const typeSelect = document.getElementById('repair-type');
      const codeSelect = document.getElementById('repair-code');
      
      if (typeSelect && codeSelect) {
        typeSelect.addEventListener('change', () => {
          const selectedType = typeSelect.value;
          codeSelect.innerHTML = '';
          
          if (!selectedType) {
            codeSelect.innerHTML = '<option value="">请先选择设备类型</option>';
            codeSelect.disabled = true;
            codeSelect.classList.add('disabled-select');
            return;
          }
          
          const codeList = getCodesByType(selectedType);
          codeSelect.disabled = false;
          codeSelect.classList.remove('disabled-select');
          
          if (codeList.length === 0) {
            codeSelect.innerHTML = '<option value="">该类型暂无设备</option>';
            return;
          }
          
          codeSelect.innerHTML = '<option value="">请选择设备编号</option>' + 
            codeList.map(item => `<option value="${item.id}">${item.code}</option>`).join('');
        });
      }
      
      // 报修提交
      const repairForm = document.getElementById('repair-apply-form');
      if (repairForm) {
        repairForm.addEventListener('submit', (e) => {
          e.preventDefault();
          console.log('提交报修 - 验证登录状态');
          
          const currentUser = getCurrentUser();
          if (!currentUser) {
            alert('登录状态失效，请重新登录！');
            localStorage.removeItem('token');
            localStorage.removeItem('login_type');
            checkLoginStatus();
            return;
          }
          
          const selectedType = document.getElementById('repair-type').value;
          const selectedCodeId = document.getElementById('repair-code').value;
          const reason = document.getElementById('repair-reason').value.trim();
          
          if (!selectedType) {
            alert('请选择设备类型！');
            typeSelect.focus();
            return;
          }
          
          if (!selectedCodeId) {
            alert('请选择设备编号！');
            codeSelect.focus();
            return;
          }
          
          if (!reason) {
            alert('请填写报修原因！');
            document.getElementById('repair-reason').focus();
            return;
          }
          
          const facilityId = parseInt(selectedCodeId);
          const repairUserId = currentUser.id;
          const date = new Date();
          const repairRecords = JSON.parse(localStorage.getItem('repair_records') || '[]');
          const seq = String(repairRecords.length + 1).padStart(3, '0');
          const orderNo = `BX${date.getFullYear()}${String(date.getMonth()+1).padStart(2,'0')}${String(date.getDate()).padStart(2,'0')}${seq}`;
          
          const newRepair = {
            id: repairRecords.length + 1,
            orderNo,
            facilityId,
            repairUserId,
            repairTime: date.toLocaleString(),
            reason,
            status: 1
          };
          
          repairRecords.push(newRepair);
          localStorage.setItem('repair_records', JSON.stringify(repairRecords));
          
          alert('报修申请提交成功！');
          renderPage('repair');
        });
      }
    }

    // 绑定添加设施事件
    function bindAddFacilityEvents() {
      const addForm = document.getElementById('add-facility-form');
      if (addForm) {
        addForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const code = document.getElementById('facility-code').value.trim();
          const type = document.getElementById('facility-type').value;
          
          if (!/^\d{8}$/.test(code)) {
            alert('设备编号必须是8位数字！');
            return;
          }
          if (!type) {
            alert('请选择设备类型！');
            return;
          }
          
          const facilities = JSON.parse(localStorage.getItem('facility_list') || '[]');
          if (facilities.some(f => f.code === code)) {
            alert('该设备编号已存在，请更换！');
            return;
          }
          
          facilities.push({
            id: facilities.length + 1,
            code,
            type,
            status: 1
          });
          localStorage.setItem('facility_list', JSON.stringify(facilities));
          alert('设备添加成功！');
          renderPage('facility');
        });
      }
    }

    // 绑定用户管理事件
    function bindUserManageEvents() {
      document.getElementById('add-user-btn')?.addEventListener('click', () => {
        openUserModal();
      });
      
      document.querySelectorAll('.edit-user-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tr = btn.closest('tr');
          const userId = tr.dataset.id;
          openUserModal(userId);
        });
      });
      
      document.querySelectorAll('.delete-user-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tr = btn.closest('tr');
          const userId = parseInt(tr.dataset.id);
          const username = tr.querySelector('td:nth-child(2)').textContent;
          
          if (confirm(`确定要删除用户【${username}】吗？`)) {
            let users = JSON.parse(localStorage.getItem('registered_users') || '[]');
            users = users.filter(user => user.id !== userId);
            localStorage.setItem('registered_users', JSON.stringify(users));
            renderPage('user');
            alert('用户删除成功！');
          }
        });
      });
    }

    // 打开用户弹窗
    function openUserModal(userId = null) {
      userModal.style.display = 'flex';
      const userForm = document.getElementById('user-form');
      userForm.reset();
      const modalTitle = document.getElementById('modal-title');
      
      if (userId) {
        modalTitle.textContent = '编辑用户';
        const users = JSON.parse(localStorage.getItem('registered_users') || '[]');
        const user = users.find(u => u.id === parseInt(userId));
        if (user) {
          document.getElementById('user-id').value = user.id;
          document.getElementById('modal-username').value = user.username;
          document.getElementById('modal-phone').value = user.phone;
          document.getElementById('modal-gender').value = user.gender;
          user.userType === 'teacher' ? document.getElementById('modal-teacher').checked = true : document.getElementById('modal-student').checked = true;
        }
      } else {
        modalTitle.textContent = '添加用户';
        document.getElementById('modal-teacher').checked = true;
        document.getElementById('modal-gender').value = '男';
      }
      
      userForm.onsubmit = function(e) {
        e.preventDefault();
        const userId = document.getElementById('user-id').value;
        const username = document.getElementById('modal-username').value.trim();
        const password = document.getElementById('modal-password').value.trim();
        const phone = document.getElementById('modal-phone').value.trim();
        const userType = Array.from(document.querySelectorAll('input[name="modal-type"]')).find(r => r.checked)?.value;
        const gender = document.getElementById('modal-gender').value;
        
        if (username.length < 3 || username.length > 16) {
          alert('用户名长度需在3-16位之间！');
          return;
        }
        if (!userId && !password) {
          alert('添加用户必须填写密码！');
          return;
        }
        if (password && (password.length < 6 || password.length > 16)) {
          alert('密码长度需在6-16位之间！');
          return;
        }
        if (!/^1[3-9]\d{9}$/.test(phone)) {
          alert('请输入有效的手机号码！');
          return;
        }
        if (!gender) {
          alert('请选择性别！');
          return;
        }
        
        let users = JSON.parse(localStorage.getItem('registered_users') || '[]');
        if (userId) {
          const index = users.findIndex(u => u.id === parseInt(userId));
          if (index !== -1) {
            users[index].username = username;
            users[index].phone = phone;
            users[index].userType = userType;
            users[index].gender = gender;
            if (password) users[index].password = password;
            localStorage.setItem('registered_users', JSON.stringify(users));
            alert('用户编辑成功！');
          }
        } else {
          if (users.some(u => u.username === username)) {
            alert('用户名已存在！');
            return;
          }
          const newUserId = users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 2;
          users.push({
            id: newUserId,
            username,
            password,
            phone,
            userType,
            gender
          });
          localStorage.setItem('registered_users', JSON.stringify(users));
          alert('用户添加成功！');
        }
        
        userModal.style.display = 'none';
        renderPage('user');
      };
    }

    // 取消弹窗
    cancelBtn.addEventListener('click', () => {
      userModal.style.display = 'none';
    });

    // 检查登录状态
    function checkLoginStatus() {
      const token = localStorage.getItem('token');
      const loginType = localStorage.getItem('login_type');
      
      if (token && loginType) {
        loginPage.style.display = 'none';
        registerPage.style.display = 'none';
        navHeader.style.display = 'flex';
        mainContent.style.display = 'block';
        
        const currentUser = getCurrentUser();
        const userType = currentUser?.userType || '';
        
        document.querySelector('.admin-menu').style.display = userType === 'admin' ? 'flex' : 'none';
        document.getElementById('menu-add').style.display = userType === 'admin' ? 'flex' : 'none';
        document.getElementById('menu-repair').style.display = userType === 'admin' ? 'none' : 'flex';
        
        renderPage('facility');
      } else {
        loginPage.style.display = 'flex';
        registerPage.style.display = 'none';
        navHeader.style.display = 'none';
        mainContent.style.display = 'none';
      }
    }

    // 初始化
    window.onload = () => {
      checkLoginStatus();
      document.getElementById('login-admin').checked = true;
    };
  </script>
</body>
</html>
