<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>智慧校园公共设施管理系统</title>
  <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/antd/5.12.8/antd.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
    }
    .auth-page {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: #f5f5f5;
    }
    .auth-card {
      width: 400px;
      padding: 32px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    }
    .auth-title {
      text-align: center;
      font-size: 24px;
      font-weight: 500;
      margin-bottom: 24px;
      color: #001529;
    }
    .auth-form .form-item {
      margin-bottom: 16px;
    }
    .auth-form label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: #333;
    }
    .auth-form input, .auth-form select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      font-size: 14px;
    }
    .auth-form input:focus, .auth-form select:focus {
      outline: none;
      border-color: #1890ff;
      box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
    }
    .radio-group {
      display: flex;
      gap: 20px;
      padding: 8px 0;
      flex-wrap: wrap;
    }
    .radio-item {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    .radio-item input {
      width: auto;
      margin: 0;
    }
    .auth-btn {
      width: 100%;
      padding: 10px;
      background: #1890ff;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 16px;
    }
    .auth-btn:hover {
      background: #40a9ff;
    }
    .auth-error {
      color: #ff4d4f;
      font-size: 12px;
      margin-bottom: 16px;
      text-align: center;
      display: none;
    }
    .auth-tip {
      text-align: center;
      font-size: 14px;
      color: #666;
    }
    .auth-switch {
      color: #1890ff;
      cursor: pointer;
      text-decoration: none;
    }
    .auth-switch:hover {
      color: #40a9ff;
      text-decoration: underline;
    }
    .nav-header {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 999;
      width: 100%;
      height: 64px;
      background: #001529;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      display: none;
    }
    .logo {
      color: #fff;
      font-size: 18px;
      font-weight: bold;
      white-space: nowrap;
    }
    .nav-menu {
      display: flex;
      margin: 0 20px;
      flex: 1;
      max-width: 600px;
    }
    .menu-item {
      color: #fff;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 16px;
      height: 64px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .menu-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    .menu-item.active {
      background: #1890ff;
    }
    .menu-item svg {
      width: 16px;
      height: 16px;
      fill: #fff;
    }
    .admin-menu {
      display: none;
    }
    .logout-btn {
      background: #1890ff;
      color: #fff;
      border: none;
      border-radius: 4px;
      width: auto;
      height: 36px;
      line-height: 36px;
      padding: 0 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
      white-space: nowrap;
    }
    .logout-btn:hover {
      background: #40a9ff;
    }
    .logout-btn svg {
      width: 16px;
      height: 16px;
      fill: #fff;
    }
    .main-content {
      margin-top: 84px;
      padding: 24px;
      background: #fff;
      margin-left: 24px;
      margin-right: 24px;
      border-radius: 8px;
      min-height: 500px;
      display: none;
    }
    .page-title {
      font-size: 20px;
      font-weight: 500;
      margin-bottom: 20px;
    }
    .add-user-btn {
      padding: 8px 16px;
      background: #52c41a;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      margin-bottom: 16px;
    }
    .add-user-btn:hover {
      background: #73d13d;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin-bottom: 24px;
    }
    .data-table th {
      background: #fafafa;
      font-weight: 500;
      color: #333;
    }
    .data-table th, .data-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
    }
    .data-table tr:hover {
      background: #f9f9f9;
    }
    .status-tag {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    .status-normal {
      background: #f0f9ff;
      color: #1890ff;
    }
    .status-pending {
      background: #fff7e6;
      color: #faad14;
    }
    .operate-btn {
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      margin-right: 8px;
    }
    .status-btn {
      background: #e6f7ff;
      color: #1890ff;
    }
    .delete-btn {
      background: #fff2f0;
      color: #ff4d4f;
    }
    .submit-btn {
      background: #1890ff;
      color: #fff;
      padding: 8px 16px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 8px;
    }
    .submit-btn:hover {
      background: #40a9ff;
    }
    .repair-form {
      background: #f9f9f9;
      padding: 24px;
      border-radius: 8px;
      margin-bottom: 24px;
      max-width: 600px;
    }
    .repair-form .form-item {
      margin-bottom: 16px;
    }
    .repair-form label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
    }
    .repair-form select, .repair-form textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      font-size: 14px;
    }
    .repair-form textarea {
      min-height: 100px;
      resize: vertical;
    }
    .disabled-select {
      background-color: #f5f5f5;
      color: #999;
    }
    .modal-mask {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      display: none;
    }
    .modal-card {
      width: 400px;
      padding: 24px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }
    .modal-title {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 16px;
      color: #333;
    }
    .modal-form .form-item {
      margin-bottom: 16px;
    }
    .modal-form label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .modal-btn-group {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }
    .modal-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }
    .confirm-btn {
      background: #1890ff;
      color: #fff;
    }
    .cancel-btn {
      background: #f5f5f5;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="auth-page" id="login-page">
    <div class="auth-card">
      <div class="auth-title">智慧校园公共设施管理系统</div>
      <div class="auth-error" id="login-error">用户名或密码错误</div>
      <form class="auth-form" id="login-form">
        <div class="form-item">
          <label for="login-username">用户名</label>
          <input type="text" id="login-username" placeholder="请输入用户名" required>
        </div>
        <div class="form-item">
          <label for="login-password">密码</label>
          <input type="password" id="login-password" placeholder="请输入密码" required>
        </div>
        <div class="form-item">
          <label>登录身份</label>
          <div class="radio-group">
            <div class="radio-item">
              <input type="radio" name="login-type" id="login-admin" value="admin" required>
              <label for="login-admin">管理员</label>
            </div>
            <div class="radio-item">
              <input type="radio" name="login-type" id="login-teacher" value="teacher">
              <label for="login-teacher">老师</label>
            </div>
            <div class="radio-item">
              <input type="radio" name="login-type" id="login-student" value="student">
              <label for="login-student">学生</label>
            </div>
          </div>
        </div>
        <button type="submit" class="auth-btn">登录</button>
        <div class="auth-tip">
          还没有账号？<span class="auth-switch" id="to-register">立即注册</span>
        </div>
      </form>
    </div>
  </div>
  <div class="auth-page" id="register-page" style="display: none;">
    <div class="auth-card">
      <div class="auth-title">用户注册</div>
      <div class="auth-error" id="register-error">注册失败，请检查信息</div>
      <form class="auth-form" id="register-form">
        <div class="form-item">
          <label for="reg-username">用户名</label>
          <input type="text" id="reg-username" placeholder="请输入用户名（3-16位）" required>
        </div>
        <div class="form-item">
          <label for="reg-password">密码</label>
          <input type="password" id="reg-password" placeholder="请输入密码（6-16位）" required>
        </div>
        <div class="form-item">
          <label for="reg-repassword">确认密码</label>
          <input type="password" id="reg-repassword" placeholder="请再次输入密码" required>
        </div>
        <div class="form-item">
          <label for="reg-phone">联系电话</label>
          <input type="tel" id="reg-phone" placeholder="请输入联系电话" required>
        </div>
        <div class="form-item">
          <label>用户身份</label>
          <div class="radio-group">
            <div class="radio-item">
              <input type="radio" name="reg-type" id="reg-teacher" value="teacher" required>
              <label for="reg-teacher">老师</label>
            </div>
            <div class="radio-item">
              <input type="radio" name="reg-type" id="reg-student" value="student">
              <label for="reg-student">学生</label>
            </div>
          </div>
        </div>
        <div class="form-item">
          <label for="reg-gender">性别</label>
          <select id="reg-gender" required>
            <option value="">请选择性别</option>
            <option value="男">男</option>
            <option value="女">女</option>
          </select>
        </div>
        <button type="submit" class="auth-btn">注册</button>
        <div class="auth-tip">
          已有账号？<span class="auth-switch" id="to-login">立即登录</span>
        </div>
      </form>
    </div>
  </div>
  <header class="nav-header" id="nav-header">
    <div class="logo">智慧校园公共设施管理系统</div>
    <div class="nav-menu">
      <a id="menu-facility" class="menu-item active" href="javascript:;">
        <svg viewBox="64 64 896 896" focusable="false">
          <path d="M946.5 505L538.9 161.2c-14.2-12.2-35-12.2-49.2 0L77.5 505a63.9 63.9 0 0 0-18.8 46c.4 35.2 29.7 63.6 65 63.6h42.5V908c0 17.7 14.2 32 31.9 32H448V714h112v196h265.4c17.7 0 32-14.3 32-32V614.7h41.3c35.2 0 64.7-28.4 65-63.6.1-7.8-1.3-15.5-4.1-22.9zM512 512c79.5 0 144-64.5 144-144s-64.5-144-144-144-144 64.5-144 144 64.5 144 144 144zm0-320c105.9 0 192 86.1 192 192s-86.1 192-192 192-192-86.1-192-192 86.1-192 192-192z"/>
        </svg>
        设施列表
      </a>
      <a id="menu-add" class="menu-item" href="javascript:;">
        <svg viewBox="64 64 896 896" focusable="false">
          <path d="M909.9 854.5L649.4 594c-12.5-12.5-32.8-12.5-45.3 0L420.7 725.7l-73.2-73.2c-12.5-12.5-32.8-12.5-45.3 0L114.1 759.7c-12.5 12.5-12.5 32.8 0 45.3l278.6 278.6c12.5 12.5 32.8 12.5 45.3 0l424.4-424.4c12.5-12.5 12.5-32.8 0-45.3zM266.3 883.6L153 770.3l145.5-145.5 42.4 42.4-78.1 78.1-42.4-42.4L195.4 650l145.5-145.5 213.2 213.2-294.4 294.4-42.4-42.4zm532.3-379.2L671.7 424l-136.2 136.2 42.4 42.4 93.8-93.8 42.4 42.4 196.4-196.4-136.2-136.2-196.4 196.4-42.4-42.4-93.8 93.8-42.4-42.4L352.3 284.7l136.2-136.2 424.4 424.4-136.2 136.2z"/>
        </svg>
        添加设施
      </a>
      <a id="menu-repair" class="menu-item" href="javascript:;">
        <svg viewBox="64 64 896 896" focusable="false">
          <path d="M878 256H728v-64c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v64H384v-64c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v64H146c-17.7 0-32 14.3-32 32v664c0 17.7 14.3 32 32 32h732c17.7 0 32-14.3 32-32V288c0-17.7-14.3-32-32-32zM664 888H360c-4.4 0-8-3.6-8-8v-56c0-4.4 3.6-8 8-8h304c4.4 0 8 3.6 8 8v56c0 4.4-3.6 8-8 8zm0-168H360c-4.4 0-8-3.6-8-8v-56c0-4.4 3.6-8 8-8h304c4.4 0 8 3.6 8 8v56c0 4.4-3.6 8-8 8zm0-168H360c-4.4 0-8-3.6-8-8v-56c0-4.4 3.6-8 8-8h304c4.4 0 8 3.6 8 8v56c0 4.4-3.6 8-8 8z"/>
        </svg>
        报修管理
      </a>
      <a id="menu-user" class="menu-item admin-menu" href="javascript:;">
        <svg viewBox="64 64 896 896" focusable="false">
          <path d="M878 256H728v-64c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v64H384v-64c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v64H146c-17.7 0-32 14.3-32 32v664c0 17.7 14.3 32 32 32h732c17.7 0 32-14.3 32-32V288c0-17.7-14.3-32-32-32zM664 888H360c-4.4 0-8-3.6-8-8v-56c0-4.4 3.6-8 8-8h304c4.4 0 8 3.6 8 8v56c0 4.4-3.6 8-8 8zm0-168H360c-4.4 0-8-3.6-8-8v-56c0-4.4 3.6-8 8-8h304c4.4 0 8 3.6 8 8v56c0 4.4-3.6 8-8 8zm0-168H360c-4.4 0-8-3.6-8-8v-56c0-4.4 3.6-8 8-8h304c4.4 0 8 3.6 8 8v56c0 4.4-3.6 8-8 8z"/>
        </svg>
        用户管理
      </a>
    </div>
    <button id="logout-btn" class="logout-btn">
      <svg viewBox="64 64 896 896" focusable="false">
        <path d="M858.5 763.6a374 374 0 0 0-80.6-119.5 375.63 375.63 0 0 0-119.5-80.6c-4.8-.8-9.6-1.2-14.3-1.2H512c-4.7 0-9.5.4-14.3 1.2a375.63 375.63 0 0 0-119.5 80.6 374 374 0 0 0-80.6 119.5c-.8 4.8-1.2 9.6-1.2 14.3v42.8c0 27.6 22.4 50 50 50h420c27.6 0 50-22.4 50-50v-42.8c.1-4.7-.3-9.5-1.1-14.3zM512 512c79.5 0 144-64.5 144-144s-64.5-144-144-144-144 64.5-144 144 64.5 144 144 144zm0-320c105.9 0 192 86.1 192 192s-86.1 192-192 192-192-86.1-192-192 86.1-192 192-192z"/>
      </svg>
      退出登录
    </button>
  </header>
  <main class="main-content" id="main-content">
    <div class="page-title" id="page-title">设施列表</div>
    <div id="page-content"></div>
  </main>
  <div class="modal-mask" id="user-modal">
    <div class="modal-card">
      <div class="modal-title" id="modal-title">添加用户</div>
      <form class="modal-form" id="user-form">
        <input type="hidden" id="user-id" value="">
        <div class="form-item">
          <label for="modal-username">用户名</label>
          <input type="text" id="modal-username" placeholder="请输入用户名" required>
        </div>
        <div class="form-item">
          <label for="modal-password">密码</label>
          <input type="password" id="modal-password" placeholder="请输入密码（编辑时留空则不修改）">
        </div>
        <div class="form-item">
          <label for="modal-phone">联系电话</label>
          <input type="tel" id="modal-phone" placeholder="请输入联系电话" required>
        </div>
        <div class="form-item">
          <label>用户身份</label>
          <div class="radio-group">
            <div class="radio-item">
              <input type="radio" name="modal-type" id="modal-teacher" value="teacher" required>
              <label for="modal-teacher">老师</label>
            </div>
            <div class="radio-item">
              <input type="radio" name="modal-type" id="modal-student" value="student">
              <label for="modal-student">学生</label>
            </div>
          </div>
        </div>
        <div class="form-item">
          <label for="modal-gender">性别</label>
          <select id="modal-gender" required>
            <option value="">请选择性别</option>
            <option value="男">男</option>
            <option value="女">女</option>
          </select>
        </div>
        <div class="modal-btn-group">
          <button type="button" class="modal-btn cancel-btn" id="cancel-btn">取消</button>
          <button type="button" class="modal-btn confirm-btn" id="save-user-btn">保存</button>
        </div>
      </form>
    </div>
  </div>
  <script>
    // 后端接口基础地址（根据实际部署地址修改）
    const BASE_API = 'http://localhost:5000/api';
    
    // 获取请求头（携带token）
    const getAuthHeaders = () => ({
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${localStorage.getItem('token')}`
    });
    
    // 状态文本转换
    const getStatusText = (type, status) => {
      if (type === 'facility') {
        return status === 1 ? '正常' : '待维修';
      } else if (type === 'repair') {
        const map = { 1: '待处理', 2: '维修中', 3: '已完成', 4: '已驳回' };
        return map[status] || '待处理';
      }
    };
    
    // 状态样式类转换
    const getStatusClass = (type, status) => {
      if (type === 'facility') {
        return status === 1 ? 'status-normal' : 'status-pending';
      } else if (type === 'repair') {
        const map = { 1: 'status-pending', 2: 'status-normal', 3: 'status-normal', 4: 'status-pending' };
        return map[status] || 'status-pending';
      }
    };
    
    // 获取当前登录用户信息
    const getCurrentUser = async () => {
      const token = localStorage.getItem('token');
      const loginType = localStorage.getItem('login_type');
      if (!token || !loginType) return null;
      try {
        const res = await fetch(`${BASE_API}/users/info`, { headers: getAuthHeaders() });
        const data = await res.json();
        if (data.success) return { ...data.data, userType: loginType };
        alert(`获取用户信息失败：${data.message || '网络异常'}`);
        return { userType: loginType };
      } catch (err) {
        console.error('获取用户信息失败：', err);
        alert('获取用户信息失败，可能是网络问题');
        return { userType: loginType };
      }
    };
    
    // 页面配置（核心修改：地点相关渲染和提交）
    const pageConfig = {
      facility: {
        title: '设施列表',
        content: async function() {
          try {
            // 强制携带token请求设施列表
            const res = await fetch(`${BASE_API}/facilities`, {
              headers: getAuthHeaders() // 新增：添加认证头，确保能获取完整数据
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);
            
            const currentUser = await getCurrentUser();
            const userType = currentUser?.userType || '';
            let html = `<table class="data-table">
              <thead><tr>
                <th>序号</th>
                <th>设备编号</th>
                <th>设备类型</th>
                <th>所在地点</th>
                <th>状态</th>`;
            if (userType === 'admin') html += '<th>操作</th>';
            html += `</tr></thead><tbody>`;
            
            data.data.forEach((item, index) => {
              // 强制读取location字段，空值显示“未填写”
              const location = item.location?.trim() || '未填写';
              html += `<tr>
                <td>${index + 1}</td>
                <td>${item.code}</td>
                <td>${item.type}</td>
                <td>${location}</td> <!-- 确保地点显示 -->
                <td><span class="status-tag ${getStatusClass('facility', item.status)}">${getStatusText('facility', item.status)}</span></td>`;
              if (userType === 'admin') {
                html += `<td>
                  <button class="operate-btn status-btn" data-id="${item._id}" data-status="${item.status}">
                    ${item.status === 1 ? '设为待维修' : '设为正常'}
                  </button>
                  <button class="operate-btn delete-btn" data-id="${item._id}">删除</button>
                </td>`;
              }
              html += `</tr>`;
            });
            html += `</tbody></table>`;
            return html;
          } catch (err) {
            return `<div style="text-align:center; color:#ff4d4f;">获取设施列表失败：${err.message}</div>`;
          }
        }
      },
      add: {
        title: '添加设施',
        content: function() {
          return `
            <form class="repair-form" id="add-facility-form">
              <div class="form-item">
                <label for="facility-code">设备编号（8位数字）</label>
                <input type="text" id="facility-code" placeholder="请输入8位数字设备编号" required pattern="\\d{8}">
              </div>
              <div class="form-item">
                <label for="facility-type">设备类型</label>
                <select id="facility-type" required>
                  <option value="">请选择设备类型</option>
                  <option value="饮水设备">饮水设备</option>
                  <option value="制冷设备">制冷设备</option>
                  <option value="照明设备">照明设备</option>
                  <option value="教学设备">教学设备</option>
                  <option value="便民设备">便民设备</option>
                </select>
              </div>
              <!-- 设备地点输入项（强制必填） -->
              <div class="form-item">
                <label for="facility-location">设备地点 <span style="color:#ff4d4f;">*</span></label>
                <input type="text" id="facility-location" placeholder="请输入设备所在地点（如：1号教学楼3楼）" required>
              </div>
              <button type="submit" class="submit-btn">提交添加</button>
            </form>
          `;
        }
      },
      repair: {
        title: '报修管理',
        content: async function() {
          const currentUser = await getCurrentUser();
          const userId = currentUser?._id || '';
          const userType = currentUser?.userType || '';
          let html = '';
          
          if (userType !== 'admin') {
            const typeOptions = `
              <option value="">请选择设备类型</option>
              <option value="饮水设备">饮水设备</option>
              <option value="制冷设备">制冷设备</option>
              <option value="照明设备">照明设备</option>
              <option value="教学设备">教学设备</option>
              <option value="便民设备">便民设备</option>
            `;
            
            html += `<div class="repair-form">
              <h3 style="margin-bottom:16px;">报修申请</h3>
              <form id="repair-apply-form">
                <div class="form-item">
                  <label for="repair-type">设备类型</label>
                  <select id="repair-type" required>${typeOptions}</select>
                </div>
                <div class="form-item">
                  <label for="repair-code">设备编号</label>
                  <select id="repair-code" class="disabled-select" disabled required>
                    <option value="">请先选择设备类型</option>
                  </select>
                </div>
                <div class="form-item">
                  <label for="repair-reason">报修原因</label>
                  <textarea id="repair-reason" placeholder="请详细描述故障情况..." required></textarea>
                </div>
                <button type="submit" class="submit-btn">提交报修</button>
              </form>
            </div>`;
          }
          
          const recordTitle = userType === 'admin' ? '所有报修记录' : '我的报修记录';
          html += `<h3 style="margin-bottom:16px;">${recordTitle}</h3>`;
          try {
            const res = await fetch(userType === 'admin' 
              ? `${BASE_API}/repairs` 
              : `${BASE_API}/repairs/my/${userId}`, 
              { headers: getAuthHeaders() }
            );
            const data = await res.json();
            if (!data.success) throw new Error(data.message);
            
            html += `<table class="data-table"><thead><tr>
              <th>工单编号</th>
              <th>设备编号</th>
              <th>设备类型</th>
              <th>所在地点</th>
              <th>报修时间</th>`;
            if (userType === 'admin') html += '<th>报修人</th>';
            html += `<th>报修原因</th>
              <th>状态</th>`;
            if (userType === 'admin') html += '<th>操作</th>';
            html += `</tr></thead><tbody>`;
            
            if (data.data.length === 0) {
              const colCount = userType === 'admin' ? 9 : 7;
              html += `<tr><td colspan="${colCount}" style="text-align:center;">暂无报修记录</td></tr>`;
            } else {
              data.data.forEach(record => {
                // 强制读取设备地点
                const location = record.facilityLocation?.trim() || '未填写';
                html += `<tr>
                  <td>${record.orderNo}</td>
                  <td>${record.facilityCode}</td>
                  <td>${record.facilityType}</td>
                  <td>${location}</td> <!-- 确保地点显示 -->
                  <td>${record.repairTime}</td>`;
                if (userType === 'admin') html += `<td>${record.repairUserInfo?.username || '未知'}</td>`;
                html += `
                  <td>${record.reason}</td>
                  <td><span class="status-tag ${getStatusClass('repair', record.status)}">${getStatusText('repair', record.status)}</span></td>`;
                if (userType === 'admin') {
                  html += `<td>
                    <button class="operate-btn status-btn" data-id="${record._id}" data-status="${record.status}">
                      修改状态
                    </button>
                  </td>`;
                }
                html += `</tr>`;
              });
            }
            html += `</tbody></table>`;
          } catch (err) {
            html += `<div style="text-align:center; color:#ff4d4f;">获取报修记录失败：${err.message}</div>`;
          }
          return html;
        }
      },
      user: {
        title: '用户管理',
        content: async function() {
          try {
            const res = await fetch(`${BASE_API}/users/list`, { headers: getAuthHeaders() });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);
            
            let html = `<button class="add-user-btn" id="add-user-btn">添加用户</button>
              <table class="data-table"><thead><tr>
                <th>用户ID</th>
                <th>用户名</th>
                <th>联系电话</th>
                <th>身份</th>
                <th>性别</th>
                <th>操作</th>
              </tr></thead><tbody>`;
            
            data.data.forEach(user => {
              if (user.userType !== 'admin') {
                html += `<tr data-id="${user._id}">
                  <td>${user._id}</td>
                  <td>${user.username}</td>
                  <td>${user.phone}</td>
                  <td>${user.userType === 'teacher' ? '老师' : '学生'}</td>
                  <td>${user.gender}</td>
                  <td>
                    <button class="operate-btn status-btn edit-user-btn" data-id="${user._id}">编辑</button>
                    <button class="operate-btn delete-btn delete-user-btn" data-id="${user._id}">删除</button>
                  </td>
                </tr>`;
              }
            });
            html += `</tbody></table>`;
            return html;
          } catch (err) {
            return `<div style="text-align:center; color:#ff4d4f;">获取用户列表失败：${err.message}</div>`;
          }
        }
      }
    };
    
    // DOM元素获取
    const loginPage = document.getElementById('login-page');
    const registerPage = document.getElementById('register-page');
    const navHeader = document.getElementById('nav-header');
    const mainContent = document.getElementById('main-content');
    const userModal = document.getElementById('user-modal');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const toRegister = document.getElementById('to-register');
    const toLogin = document.getElementById('to-login');
    const menuItems = document.querySelectorAll('.menu-item');
    const logoutBtn = document.getElementById('logout-btn');
    const pageTitle = document.getElementById('page-title');
    const pageContent = document.getElementById('page-content');
    const cancelBtn = document.getElementById('cancel-btn');
    const saveUserBtn = document.getElementById('save-user-btn');
    
    // 登录/注册切换
    toRegister.addEventListener('click', () => {
      loginPage.style.display = 'none';
      registerPage.style.display = 'flex';
      document.getElementById('register-error').style.display = 'none';
      document.getElementById('reg-teacher').checked = true;
      document.getElementById('reg-gender').value = '男';
    });
    toLogin.addEventListener('click', () => {
      registerPage.style.display = 'none';
      loginPage.style.display = 'flex';
      document.getElementById('login-error').style.display = 'none';
      document.getElementById('login-admin').checked = true;
    });
    
    // 注册提交
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('reg-username').value.trim();
      const password = document.getElementById('reg-password').value.trim();
      const repassword = document.getElementById('reg-repassword').value.trim();
      const phone = document.getElementById('reg-phone').value.trim();
      const regType = Array.from(document.querySelectorAll('input[name="reg-type"]')).find(r => r.checked)?.value;
      const gender = document.getElementById('reg-gender').value;
      const errorEl = document.getElementById('register-error');
      
      // 表单校验
      if (username.length < 3 || username.length > 16) {
        errorEl.textContent = '用户名长度需在3-16位之间';
        errorEl.style.display = 'block';
        return;
      }
      if (password.length < 6 || password.length > 16) {
        errorEl.textContent = '密码长度需在6-16位之间';
        errorEl.style.display = 'block';
        return;
      }
      if (password !== repassword) {
        errorEl.textContent = '两次输入的密码不一致';
        errorEl.style.display = 'block';
        return;
      }
      if (!/^1[3-9]\d{9}$/.test(phone)) {
        errorEl.textContent = '请输入有效的手机号码';
        errorEl.style.display = 'block';
        return;
      }
      if (!gender) {
        errorEl.textContent = '请选择性别';
        errorEl.style.display = 'block';
        return;
      }
      
      try {
        const res = await fetch(`${BASE_API}/users/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password, phone, userType: regType, gender })
        });
        const data = await res.json();
        if (data.success) {
          localStorage.setItem('token', data.data.token);
          localStorage.setItem('login_type', regType);
          alert(`注册成功！您的身份是：${regType === 'teacher' ? '老师' : '学生'}`);
          toLogin.click();
          document.getElementById('login-username').value = username;
        } else {
          errorEl.textContent = data.message;
          errorEl.style.display = 'block';
        }
      } catch (err) {
        errorEl.textContent = '注册失败，请检查后端服务是否启动';
        errorEl.style.display = 'block';
      }
    });
    
    // 登录提交
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value.trim();
      const loginType = Array.from(document.querySelectorAll('input[name="login-type"]')).find(r => r.checked)?.value;
      const errorEl = document.getElementById('login-error');
      
      try {
        const res = await fetch(`${BASE_API}/users/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password, userType: loginType })
        });
        const data = await res.json();
        if (data.success) {
          localStorage.setItem('token', data.data.token);
          localStorage.setItem('login_type', loginType);
          checkLoginStatus();
          alert(data.message);
        } else {
          errorEl.textContent = data.message;
          errorEl.style.display = 'block';
        }
      } catch (err) {
        errorEl.textContent = '登录失败，请检查后端服务';
        errorEl.style.display = 'block';
      }
    });
    
    // 退出登录
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('token');
      localStorage.removeItem('login_type');
      checkLoginStatus();
      alert('退出登录成功！');
    });
    
    // 菜单点击
    menuItems.forEach(item => {
      item.addEventListener('click', async () => {
        const pageKey = item.id.split('-')[1];
        const currentUser = await getCurrentUser();
        const userType = currentUser?.userType || '';
        
        // 权限校验
        if (pageKey === 'add' && userType !== 'admin') {
          alert('抱歉，只有管理员有权限添加设备！');
          return;
        }
        
        // 切换激活菜单
        menuItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        
        // 渲染页面
        pageTitle.textContent = pageConfig[pageKey].title;
        pageContent.innerHTML = '加载中...';
        const content = pageKey === 'add' ? pageConfig[pageKey].content() : await pageConfig[pageKey].content();
        pageContent.innerHTML = content;
        
        // 绑定对应事件
        if (pageKey === 'repair') bindRepairEvents();
        if (pageKey === 'add') bindAddFacilityEvents();
        if (pageKey === 'user') bindUserManageEvents();
        if (pageKey === 'facility') bindFacilityEvents();
      });
    });
    
    // 渲染页面通用方法
    async function renderPage(pageKey = 'facility') {
      pageTitle.textContent = pageConfig[pageKey].title;
      pageContent.innerHTML = '加载中...';
      const content = pageKey === 'add' ? pageConfig[pageKey].content() : await pageConfig[pageKey].content();
      pageContent.innerHTML = content;
      
      // 绑定对应事件
      if (pageKey === 'repair') bindRepairEvents();
      if (pageKey === 'add') bindAddFacilityEvents();
      if (pageKey === 'user') bindUserManageEvents();
      if (pageKey === 'facility') bindFacilityEvents();
    }
    
    // 设施列表事件绑定
    function bindFacilityEvents() {
      // 修改设备状态
      document.querySelectorAll('.status-btn[data-id]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const facilityId = btn.dataset.id;
          const currentStatus = parseInt(btn.dataset.status);
          const newStatus = currentStatus === 1 ? 2 : 1;
          
          if (confirm(`确定要将该设备状态改为【${getStatusText('facility', newStatus)}】吗？`)) {
            try {
              const res = await fetch(`${BASE_API}/facilities/status/${facilityId}`, {
                method: 'PATCH',
                headers: getAuthHeaders(),
                body: JSON.stringify({ status: newStatus })
              });
              const data = await res.json();
              if (data.success) {
                alert(data.message);
                renderPage('facility');
              } else {
                alert(`修改失败：${data.message}`);
              }
            } catch (err) {
              alert('修改失败，请检查后端服务');
            }
          }
        });
      });
      
      // 删除设备
      document.querySelectorAll('.delete-btn[data-id]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const facilityId = btn.dataset.id;
          if (confirm('确定删除该设备吗？')) {
            try {
              const res = await fetch(`${BASE_API}/facilities/${facilityId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
              });
              const data = await res.json();
              if (data.success) {
                alert('设备删除成功！');
                renderPage('facility');
              } else {
                alert(`删除失败：${data.message}`);
              }
            } catch (err) {
              alert('删除失败，请检查后端服务');
            }
          }
        });
      });
    }
    
    // 添加设施事件绑定（核心修改：确保地点正确提交）
    function bindAddFacilityEvents() {
      const addForm = document.getElementById('add-facility-form');
      addForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // 获取表单值（强制trim去空格）
        const code = document.getElementById('facility-code').value.trim();
        const type = document.getElementById('facility-type').value;
        const location = document.getElementById('facility-location').value.trim();
        
        // 严格校验
        if (!/^\d{8}$/.test(code)) {
          alert('设备编号必须是8位数字！');
          return;
        }
        if (!type) {
          alert('请选择设备类型！');
          return;
        }
        if (!location) {
          alert('请输入设备所在地点（如：1号教学楼3楼）！');
          return;
        }
        
        try {
          // 打印提交数据（便于调试）
          console.log('提交的设施数据：', { code, type, location });
          
          // 提交请求（强制携带token和location字段）
          const res = await fetch(`${BASE_API}/facilities`, {
            method: 'POST',
            headers: getAuthHeaders(), // 必须携带token
            body: JSON.stringify({ 
              code, 
              type, 
              location // 确保传递location字段
            })
          });
          
          const data = await res.json();
          if (data.success) {
            alert(data.message);
            // 清空表单
            addForm.reset();
            // 刷新设施列表
            renderPage('facility');
          } else {
            alert(`添加失败：${data.message}`);
          }
        } catch (err) {
          console.error('添加设施失败：', err);
          alert('添加失败，请检查后端服务或网络');
        }
      });
    }
    
    // 报修管理事件绑定
    function bindRepairEvents() {
      const typeSelect = document.getElementById('repair-type');
      const codeSelect = document.getElementById('repair-code');
      let facilityIdMap = {};
      let facilityLocationMap = {}; // 存储设备编号-地点映射
      
      // 设备类型选择事件
      if (typeSelect && codeSelect) {
        typeSelect.addEventListener('change', async () => {
          const selectedType = typeSelect.value;
          codeSelect.innerHTML = '<option value="">加载中...</option>';
          facilityIdMap = {};
          facilityLocationMap = {};
          
          try {
            const res = await fetch(`${BASE_API}/facilities`, { 
              headers: getAuthHeaders() 
            });
            const data = await res.json();
            
            if (data.success) {
              const filteredFacilities = data.data.filter(f => f.type === selectedType);
              codeSelect.disabled = false;
              codeSelect.classList.remove('disabled-select');
              
              if (filteredFacilities.length === 0) {
                codeSelect.innerHTML = '<option value="">该类型暂无设备</option>';
              } else {
                // 构建设备编号-地点映射
                facilityIdMap = filteredFacilities.reduce((map, f) => {
                  map[f.code] = f._id;
                  facilityLocationMap[f.code] = f.location || '未填写';
                  return map;
                }, {});
                
                // 下拉选项显示地点
                codeSelect.innerHTML = '<option value="">请选择设备编号</option>' + 
                  filteredFacilities.map(f => `<option value="${f.code}">${f.code}（${f.location || '未填写'}）</option>`).join('');
              }
            } else {
              // 测试数据
              codeSelect.innerHTML = `
                <option value="">接口获取失败，使用测试数据</option>
                <option value="10000001">10000001（测试地点）</option>
              `;
              facilityIdMap['10000001'] = 'test-id-1';
              facilityLocationMap['10000001'] = '测试地点';
            }
          } catch (err) {
            // 测试数据
            codeSelect.innerHTML = `
              <option value="">网络异常，使用测试数据</option>
              <option value="10000001">10000001（测试地点）</option>
            `;
            facilityIdMap['10000001'] = 'test-id-1';
            facilityLocationMap['10000001'] = '测试地点';
          }
        });
      }
      
      // 报修提交事件
      const repairForm = document.getElementById('repair-apply-form');
      if (repairForm) {
        repairForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const currentUser = await getCurrentUser();
          if (!currentUser) {
            alert('登录状态失效，请重新登录！');
            return;
          }
          
          // 获取表单值
          const facilityCode = document.getElementById('repair-code').value;
          const reason = document.getElementById('repair-reason').value.trim();
          const facilityType = document.getElementById('repair-type').value;
          const facilityId = facilityIdMap[facilityCode];
          const facilityLocation = facilityLocationMap[facilityCode] || '未填写';
          
          // 校验
          if (!facilityId) {
            alert('请先选择有效的设备编号！');
            return;
          }
          if (!reason) {
            alert('请填写报修原因！');
            return;
          }
          
          try {
            const res = await fetch(`${BASE_API}/repairs`, {
              method: 'POST',
              headers: getAuthHeaders(),
              body: JSON.stringify({ 
                facilityId,
                facilityCode,
                facilityType,
                facilityLocation, // 传递设备地点
                repairUserId: currentUser._id, 
                reason 
              })
            });
            const data = await res.json();
            if (data.success) {
              alert(data.message);
              repairForm.reset();
              renderPage('repair');
            } else {
              alert(`报修失败：${data.message}`);
            }
          } catch (err) {
            alert('报修失败，请检查后端服务');
          }
        });
      }
      
      // 修改报修状态
      document.querySelectorAll('.status-btn[data-id][data-status]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const repairId = btn.dataset.id;
          const currentStatus = parseInt(btn.dataset.status);
          const statusOptions = [
            { value: 1, text: '待处理' },
            { value: 2, text: '维修中' },
            { value: 3, text: '已完成' },
            { value: 4, text: '已驳回' }
          ];
          const newStatusText = prompt(`当前状态：${getStatusText('repair', currentStatus)}\n请输入新状态编号：\n1-待处理 2-维修中 3-已完成 4-已驳回`);
          const newStatus = parseInt(newStatusText);
          
          if (![1,2,3,4].includes(newStatus)) {
            alert('状态仅支持1-4！');
            return;
          }
          
          try {
            const res = await fetch(`${BASE_API}/repairs/status/${repairId}`, {
              method: 'PATCH',
              headers: getAuthHeaders(),
              body: JSON.stringify({ status: newStatus })
            });
            const data = await res.json();
            if (data.success) {
              alert(data.message);
              renderPage('repair');
            } else {
              alert(`修改失败：${data.message}`);
            }
          } catch (err) {
            alert('修改失败，请检查后端服务');
          }
        });
      });
    }
    
    // 用户管理事件绑定
    function bindUserManageEvents() {
      // 编辑用户
      document.querySelectorAll('.edit-user-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const userId = btn.dataset.id;
          try {
            const row = btn.closest('tr');
            const username = row.querySelector('td:nth-child(2)').textContent;
            const phone = row.querySelector('td:nth-child(3)').textContent;
            const userType = row.querySelector('td:nth-child(4)').textContent === '老师' ? 'teacher' : 'student';
            const gender = row.querySelector('td:nth-child(5)').textContent;
            
            // 填充表单
            document.getElementById('user-id').value = userId;
            document.getElementById('modal-username').value = username;
            document.getElementById('modal-password').value = '';
            document.getElementById('modal-phone').value = phone;
            document.getElementById(`modal-${userType}`).checked = true;
            document.getElementById('modal-gender').value = gender;
            document.getElementById('modal-title').textContent = '编辑用户';
            
            // 显示弹窗
            userModal.style.display = 'flex';
          } catch (err) {
            alert(`编辑用户失败：${err.message || '无法获取用户信息'}`);
          }
        });
      });
      
      // 删除用户
      document.querySelectorAll('.delete-user-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const userId = btn.dataset.id;
          if (!confirm('确定要删除该用户吗？')) return;
          
          try {
            const res = await fetch(`${BASE_API}/users/${userId}`, {
              method: 'DELETE',
              headers: getAuthHeaders()
            });
            const data = await res.json();
            if (data.success) {
              alert('用户删除成功！');
              renderPage('user');
            } else {
              alert(`删除失败：${data.message}`);
            }
          } catch (err) {
            alert('删除失败，请检查后端服务');
          }
        });
      });
      
      // 添加用户按钮
      document.getElementById('add-user-btn')?.addEventListener('click', () => {
        // 清空表单
        document.getElementById('user-id').value = '';
        document.getElementById('modal-username').value = '';
        document.getElementById('modal-password').value = '';
        document.getElementById('modal-phone').value = '';
        document.getElementById('modal-teacher').checked = true;
        document.getElementById('modal-gender').value = '男';
        document.getElementById('modal-title').textContent = '添加用户';
        
        // 显示弹窗
        userModal.style.display = 'flex';
      });
    }
    
    // 保存用户（添加/编辑）
    saveUserBtn.addEventListener('click', async () => {
      const username = document.getElementById('modal-username').value.trim();
      const password = document.getElementById('modal-password').value.trim();
      const phone = document.getElementById('modal-phone').value.trim();
      const userType = Array.from(document.querySelectorAll('input[name="modal-type"]')).find(r => r.checked)?.value;
      const gender = document.getElementById('modal-gender').value;
      const userId = document.getElementById('user-id').value;
      
      // 表单校验
      if (username.length < 3 || username.length > 16) {
        alert('用户名长度需在3-16位之间！');
        return;
      }
      if (!userId && !password) {
        alert('添加用户必须填写密码！');
        return;
      }
      if (password && (password.length < 6 || password.length > 16)) {
        alert('密码长度需在6-16位之间！');
        return;
      }
      if (!/^1[3-9]\d{9}$/.test(phone)) {
        alert('请输入有效的手机号码！');
        return;
      }
      if (!gender) {
        alert('请选择性别！');
        return;
      }
      if (!userType) {
        alert('请选择用户身份！');
        return;
      }
      
      try {
        let res, data;
        const requestData = { username, phone, userType, gender };
        if (password) requestData.password = password;
        
        if (userId) {
          // 编辑用户
          res = await fetch(`${BASE_API}/users/${userId}`, {
            method: 'PUT',
            headers: getAuthHeaders(),
            body: JSON.stringify(requestData)
          });
        } else {
          // 添加用户
          res = await fetch(`${BASE_API}/users/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData)
          });
        }
        data = await res.json();
        
        if (data.success) {
          alert(userId ? '用户编辑成功！' : '用户添加成功！');
          userModal.style.display = 'none';
          renderPage('user');
        } else {
          alert(`操作失败：${data.message}`);
        }
      } catch (err) {
        alert('操作失败，请检查后端服务');
      }
    });
    
    // 取消弹窗
    cancelBtn.addEventListener('click', () => {
      userModal.style.display = 'none';
    });
    
    // 检查登录状态
    async function checkLoginStatus() {
      const token = localStorage.getItem('token');
      const loginType = localStorage.getItem('login_type');
      
      if (token && loginType) {
        // 已登录
        loginPage.style.display = 'none';
        registerPage.style.display = 'none';
        navHeader.style.display = 'flex';
        mainContent.style.display = 'block';
        
        // 显示/隐藏管理员菜单
        const currentUser = await getCurrentUser();
        const userType = currentUser?.userType || '';
        document.querySelector('.admin-menu').style.display = userType === 'admin' ? 'flex' : 'none';
        document.getElementById('menu-add').style.display = userType === 'admin' ? 'flex' : 'none';
        
        // 渲染默认页面
        renderPage('facility');
      } else {
        // 未登录
        loginPage.style.display = 'flex';
        registerPage.style.display = 'none';
        navHeader.style.display = 'none';
        mainContent.style.display = 'none';
      }
    }
    
    // 页面加载时检查登录状态
    window.onload = () => {
      checkLoginStatus();
      document.getElementById('login-admin').checked = true;
    };
  </script>
</body>
</html>
